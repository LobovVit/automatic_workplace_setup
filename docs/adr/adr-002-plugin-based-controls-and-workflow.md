# ADR-002 — Архитектура WorkflowEngine и плагинных контролей мастера автонастройки

## Статус
Accepted

## Контекст

Мастер выполняет множество разнородных проверок и действий:

- CryptoPro CSP/Plugin
- сертификаты (root/intermediate/personal)
- драйверы Rutoken
- проверки конкурирующих TLS-клиентов
- доступность портала ЛК ЭБ

Функции часто изменяются, должны расширяться без переписывания мастера.

Кроме того, Windows и Linux требуют разных проверок, но единый код должен работать в обеих ОС.

## Решение

### 1. Используется **плагинная архитектура Controls**

Каждый контроль — отдельная единица логики:

    interface IControl
    {
        string Name { get; }
        CheckResult Check();
        FixResult Fix(CheckResult result);
    }

Преимущества:

- легко добавлять новые контроли;
- можно отключать/включать контроли конфигурацией;
- разные ОС могут иметь разные наборы контролей;
- код мастера не меняется при добавлении новых проверок.

---

### 2. WorkflowEngine управляет исполнением контролей

Алгоритм:

    foreach (var control in controls)
    {
        var check = control.Check();
        if (!check.IsOk)
            var fix = control.Fix(check);
    }

Engine формирует:

- лог,
- итоговый отчёт,
- единое дерево статусов.

---

### 3. Модель данных CheckResult/FixResult

Содержит:

- тип проблемы,
- статус,
- текстовое описание,
- флаги успешности,
- дополнительные диагностические данные.

---

### 4. Связь с MVVM

- WorkflowEngine → ViewModels (обновление данных UI)
- ViewModels → Views (XAML визуализация)

UI не знает о деталях контролей.

## Последствия

### Положительные
- гибкая расширяемая система;
- единый движок под Windows и Linux;
- минимальные изменения в будущем;
- чистая архитектура MVVM.

### Отрицательные
- требуется тщательное логирование для сложных сценариев.