@startuml event-flow-master
title Event Flow – Настройка рабочего места и вход в ЛК ГИИС ЭБ

actor User as U

participant "Браузер\nпользователя" as B
participant "Портал\nвхода в ЛК" as P
participant "Backend / Nginx\n(статус, новости,\nфайлы мастера)" as BE
participant "Мастер автонастройки\n(Desktop App)" as M
participant "Контролы мастера\n(IControl + плагины)" as C
participant "ЛК ГИИС ЭБ\n(портал)" as EB

' --- Открытие портала входа ---
U -> B : Открыть URL портала входа\n(страница помощи и входа)
B -> P : HTTP GET /landing
P --> B : HTML + JS + ссылки\n(Вход, Автонастройка, Инструкция)

' --- Загрузка статусов и новостей (опционально через backend) ---
B -> BE : HTTP GET /status.json\nили /api/status
BE --> B : Текущий статус подсистем
B -> BE : HTTP GET /news.json\nили /api/news
BE --> B : Новости/уведомления
note over B
Отображаются блоки «Авария» и «Новости».
end note

' --- Пользователь выбирает автонастройку ---
U -> B : Нажать «Автоматическая настройка»
B -> P : HTTP GET /download/master?os=...
P --> B : Файл мастера\n(EXE / AppImage / скрипт)
B --> U : Сохранить файл на диск

' --- Запуск мастера на рабочем месте ---
U -> M : Запуск мастера\n(при необходимости от имени администратора)
activate M

M -> U : Показ стартового экрана\n(описание процесса, запрос прав)
U --> M : Подтверждение начала диагностики

' --- Цикл по контролам ---
loop Для каждого контрола в WorkflowEngine
  M -> C : select next IControl
  M -> C : check()
  C --> M : CheckResult (OK/WARNING/ERROR)

  alt Требуется исправление
    M -> C : fix(CheckResult)
    C --> M : FixResult
  end

  M -> M : Логирование результатов\n(временный лог, накопление отчёта)
end

' --- Итог мастера ---
alt Все критичные проверки ОК
  M -> U : Показ экрана «Рабочее место настроено»
  U -> M : Нажать «Открыть ЛК ГИИС ЭБ»
  M -> EB : Открыть URL ЛК в системном браузере
  EB --> U : Страница входа в ЛК
else Есть ошибки/предупреждения
  M -> U : Показ экрана с проблемами\nи рекомендациями
  U -> M : При необходимости «Сохранить отчёт»
  M -> U : Сохранить отчёт в файл\n(по выбранному пути)
end

' --- Завершение мастера ---
U -> M : Закрыть мастер
M -> M : Удалить временные логи/отчёты
deactivate M

@enduml
